/*
 * TAP Controller - ESP32 Firmware (Demo Version)
 *
 * 이 펌웨어는 BLE를 통해 웹앱과 통신하며,
 * 릴레이를 제어하여 컴프레서와 솔레노이드 밸브를 작동시킵니다.
 *
 * 시연용 버전: 압력 센서 없이 웹앱에서만 시뮬레이션
 *
 * 하드웨어 연결:
 * - GPIO 26: 주입 릴레이 (컴프레서 제어 - Active LOW)
 * - GPIO 27: 배출 릴레이 (솔레노이드 밸브 제어 - Active LOW)
 */

#include <BLE2902.h>
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>

// BLE UUIDs - 웹앱과 동일해야 함
#define SERVICE_UUID "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"

// GPIO 핀 정의
#define SOLENOID_PIN 27   // 3채널: 솔레노이드 밸브 (배출) - Active LOW
#define COMPRESSOR_PIN 26 // 2채널: 컴프레셔 (주입) - Active LOW

// BLE 변수
BLEServer *pServer = NULL;
BLECharacteristic *pCharacteristic = NULL;
bool deviceConnected = false;
bool oldDeviceConnected = false;

// 릴레이 상태
bool inflateRelayOn = false;
bool deflateRelayOn = false;

// 함수 선언
void setInflateRelay(bool state);
void setDeflateRelay(bool state);
void handleCommand(char cmd);

// BLE 서버 콜백
class MyServerCallbacks : public BLEServerCallbacks {
  void onConnect(BLEServer *pServer) {
    deviceConnected = true;
    Serial.println("Client connected");
  };

  void onDisconnect(BLEServer *pServer) {
    deviceConnected = false;
    Serial.println("Client disconnected");
    // 연결 끊어지면 모든 릴레이 끄기
    setInflateRelay(false);
    setDeflateRelay(false);
  }
};

// BLE 특성 콜백 - 웹앱에서 명령 수신
class MyCallbacks : public BLECharacteristicCallbacks {
  void onWrite(BLECharacteristic *pCharacteristic) {
    String value = pCharacteristic->getValue().c_str();

    if (value.length() > 0) {
      char cmd = value[0];
      Serial.print("Received command: ");
      Serial.println(cmd);

      handleCommand(cmd);
    }
  }
};

void setup() {
  Serial.begin(115200);
  Serial.println("TAP Controller Starting...");

  // GPIO 초기화
  pinMode(SOLENOID_PIN, OUTPUT);
  pinMode(COMPRESSOR_PIN, OUTPUT);

  // 초기 상태 설정
  // Solenoid (Active LOW): OFF = HIGH
  digitalWrite(SOLENOID_PIN, HIGH);
  // Compressor (Active LOW): OFF = HIGH
  digitalWrite(COMPRESSOR_PIN, HIGH);

  // BLE 초기화
  BLEDevice::init("TAP_Controller");

  // BLE 서버 생성
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());

  // BLE 서비스 생성
  BLEService *pService = pServer->createService(SERVICE_UUID);

  // BLE 특성 생성
  pCharacteristic = pService->createCharacteristic(
      CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_READ |
                               BLECharacteristic::PROPERTY_WRITE |
                               BLECharacteristic::PROPERTY_NOTIFY |
                               BLECharacteristic::PROPERTY_INDICATE);

  pCharacteristic->addDescriptor(new BLE2902());
  pCharacteristic->setCallbacks(new MyCallbacks());

  // 서비스 시작
  pService->start();

  // 광고 시작
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(false);
  pAdvertising->setMinPreferred(0x0);
  BLEDevice::startAdvertising();

  Serial.println("BLE advertising started. Waiting for connection...");
}

void loop() {
  // 연결 상태 변경 처리
  if (!deviceConnected && oldDeviceConnected) {
    delay(500);
    pServer->startAdvertising();
    Serial.println("Start advertising again");
    oldDeviceConnected = deviceConnected;
  }

  if (deviceConnected && !oldDeviceConnected) {
    oldDeviceConnected = deviceConnected;
  }

  delay(10);
}

// 명령 처리
void handleCommand(char cmd) {
  switch (cmd) {
  case 'I': // Inflate ON
    setInflateRelay(true);
    Serial.println("Inflate (Compressor) ON");
    break;

  case 'i': // Inflate OFF
    setInflateRelay(false);
    Serial.println("Inflate (Compressor) OFF");
    break;

  case 'D': // Deflate ON
    setDeflateRelay(true);
    Serial.println("Deflate (Solenoid) ON");
    break;

  case 'd': // Deflate OFF
    setDeflateRelay(false);
    Serial.println("Deflate (Solenoid) OFF");
    break;

  default:
    Serial.print("Unknown command: ");
    Serial.println(cmd);
    break;
  }
}

// 주입 릴레이 제어 (컴프레셔 - Active LOW)
void setInflateRelay(bool state) {
  // 안전: 동시에 두 릴레이가 켜지지 않도록
  if (state && deflateRelayOn) {
    setDeflateRelay(false);
  }

  inflateRelayOn = state;
  // Active LOW: ON=LOW, OFF=HIGH
  digitalWrite(COMPRESSOR_PIN, state ? LOW : HIGH);

  Serial.print("Compressor (GPIO 26): ");
  Serial.println(state ? "ON (LOW)" : "OFF (HIGH)");
}

// 배출 릴레이 제어 (솔레노이드 - Active LOW)
void setDeflateRelay(bool state) {
  // 안전: 동시에 두 릴레이가 켜지지 않도록
  if (state && inflateRelayOn) {
    setInflateRelay(false);
  }

  deflateRelayOn = state;
  // Active LOW: ON=LOW, OFF=HIGH
  digitalWrite(SOLENOID_PIN, state ? LOW : HIGH);

  Serial.print("Solenoid (GPIO 25): ");
  Serial.println(state ? "ON (LOW)" : "OFF (HIGH)");
}
