<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAP Controller</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TAP">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-color: #ffffff;
            --inflate-color: #4ade80;
            --deflate-color: #f87171;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 1rem;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        header {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -1px;
        }

        .status-badge {
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 600;
            background: #333;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .status-badge.connected {
            color: #15803d;
            background: #dcfce7;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
        }

        .pressure-display {
            text-align: center;
            margin: 1rem 0;
            transition: opacity 0.3s ease;
        }

        .pressure-display.hidden {
            display: none;
        }

        #pressure-value {
            font-size: 4rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        .pressure-unit {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-left: 0.5rem;
            vertical-align: super;
        }

        .target-control {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #111;
            border-radius: 1rem;
            border: 2px solid #333;
        }

        .target-control.hidden {
            display: none;
        }

        .target-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .target-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .target-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #333;
            background: #222;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .target-btn:active {
            transform: scale(0.95);
            background: #444;
        }

        .target-input {
            width: 80px;
            height: 40px;
            border: 2px solid #333;
            background: #222;
            border-radius: 0.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
        }

        .target-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .target-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .btn-auto {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-auto:active {
            transform: scale(0.98);
        }

        .btn-auto.active {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
            box-shadow: 0 4px 6px -1px rgba(248, 113, 113, 0.3);
        }

        .btn-primary {
            width: 100%;
            padding: 1.2rem;
            border: none;
            border-radius: 1rem;
            background: var(--accent-color);
            color: #000;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.1);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-grow: 1;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
            padding: 2rem 0;
        }

        .controls.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .control-group {
            flex: 1;
            display: flex;
        }

        .btn-control {
            width: 100%;
            min-height: 120px;
            border: none;
            border-radius: 1.5rem;
            background: #111;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #333;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-control .label {
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .btn-control .sub-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .btn-control.inflate:active,
        .btn-control.inflate.active {
            background: #064e3b;
            border-color: var(--inflate-color);
            transform: scale(0.98);
        }

        .btn-control.inflate:active .label,
        .btn-control.inflate.active .label {
            color: var(--inflate-color);
        }

        .btn-control.deflate:active,
        .btn-control.deflate.active {
            background: #7f1d1d;
            border-color: var(--deflate-color);
            transform: scale(0.98);
        }

        .btn-control.deflate:active .label,
        .btn-control.deflate.active .label {
            color: var(--deflate-color);
        }

        .btn-control.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .log-area {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            min-height: 1.5rem;
            padding-bottom: 1rem;
        }

        .btn-secondary {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 1rem;
            background: #222;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:active {
            background: #333;
            color: var(--text-primary);
        }

        .fullscreen-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn.fullscreen-active {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
        }

        .car-container {
            position: relative;
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .car-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            opacity: 0.9;
        }

        .tire-btn {
            position: absolute;
            background: none;
            border: none;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tire-btn:active {
            transform: scale(0.95);
        }

        .tire-psi {
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .tire-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .tire-timestamp {
            font-size: 0.7rem;
            color: #888;
            margin-top: 0.2rem;
            display: none;
            /* Hidden by default */
        }

        .tire-btn.fixed .tire-timestamp {
            display: block;
        }

        /* Positioning Tire Buttons (Adjust based on image) */
        .tire-btn.fl {
            top: 20%;
            left: 10%;
        }

        .tire-btn.fr {
            top: 20%;
            right: 10%;
        }

        .tire-btn.rl {
            bottom: 25%;
            left: 10%;
        }

        .tire-btn.rr {
            bottom: 25%;
            right: 10%;
        }

        .dashboard-footer {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: auto;
            width: 100%;
        }

        .footer-btn {
            background: #111;
            border: none;
            border-radius: 1rem;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .footer-btn:active {
            background: #222;
            transform: scale(0.95);
        }

        .footer-btn .icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.2rem;
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1rem;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .hidden {
            display: none !important;
        }

        .media-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            position: relative;
            display: flex;
            justify-content: center;
            -webkit-mask-image: radial-gradient(closest-side, black 85%, transparent 100%);
            mask-image: radial-gradient(closest-side, black 85%, transparent 100%);
        }

        .intro-car-video {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
            opacity: 0.9;
            border-radius: 1rem;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom,
                    transparent 0%,
                    rgba(255, 255, 255, 0.1) 40%,
                    rgba(255, 255, 255, 0.4) 50%,
                    rgba(255, 255, 255, 0.1) 60%,
                    transparent 100%);
            background-size: 100% 200%;
            animation: scan 3s linear infinite;
            pointer-events: none;
            z-index: 10;
            border-radius: 1rem;
            mix-blend-mode: overlay;
        }

        @keyframes scan {
            0% {
                background-position: 0% -100%;
            }

            100% {
                background-position: 0% 200%;
            }
        }

        .animated-car {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* Drive Mode Controls */
        .drive-mode-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .mode-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid #333;
            border-radius: 9999px;
            background: #111;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn:active {
            transform: scale(0.95);
        }

        /* Normal Mode - Blue */
        .mode-btn[data-mode="normal"].active {
            background: #0ea5e9;
            border-color: #0ea5e9;
            color: #fff;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        /* Sports Mode - Orange */
        .mode-btn[data-mode="sports"].active {
            background: #f97316;
            border-color: #f97316;
            color: #fff;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.4);
        }

        /* Comfort Mode - Purple */
        .mode-btn[data-mode="comfort"].active {
            background: #8b5cf6;
            border-color: #8b5cf6;
            color: #fff;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }

        /* Smart Mode - White */
        .mode-btn[data-mode="smart"].active {
            background: #ffffff;
            border-color: #ffffff;
            color: #000;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal.hidden {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid #333;
            position: relative;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #666;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .smart-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .smart-select {
            padding: 1rem;
            background: #222;
            border: 1px solid #444;
            border-radius: 0.75rem;
            color: #fff;
            font-size: 1rem;
            outline: none;
        }

        .recommendation {
            margin: 1.5rem 0;
            font-size: 1.1rem;
            color: #a0a0a0;
        }

        #rec-psi {
            color: #fff;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .btn-neon-white {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            background: #ffffff;
            color: #000;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }

        .btn-neon-white:active {
            transform: scale(0.98);
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1 class="logo-text">TAP Controller</h1>
            <div id="connection-status" class="status-badge disconnected">연결 끊김</div>
        </header>
        <main id="main-content">
            <!-- Connection View -->
            <div id="connection-view">
                <div class="media-container">
                    <div class="scanner-overlay"></div>
                    <video class="intro-car-video" autoplay loop muted playsinline poster="car_3d_render.png">
                        <source src="car_rotate.mp4" type="video/mp4">
                        <img src="car_3d_render.png" alt="3D Car View" class="intro-car-video animated-car">
                    </video>
                </div>
                <button id="connect-btn" class="btn-primary"><i data-lucide="link"></i> 장치 연결</button>
                <button id="test-mode-btn" class="btn-secondary"><i data-lucide="flask-conical"></i> 테스트 모드
                    (시뮬레이션)</button>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <div class="car-container">
                    <img src="car_top_view.png" alt="Car View" class="car-image"
                        onerror="this.src='https://placehold.co/300x600/1a1a1a/FFF?text=Car+Image'">

                    <!-- Tire Buttons -->
                    <button class="tire-btn fl fixed" data-tire="FL">
                        <span class="tire-psi">--</span>
                        <span class="tire-label">psi</span>
                        <span class="tire-timestamp">1분 전</span>
                    </button>
                    <button class="tire-btn fr fixed" data-tire="FR">
                        <span class="tire-psi">--</span>
                        <span class="tire-label">psi</span>
                        <span class="tire-timestamp">1분 전</span>
                    </button>
                    <button class="tire-btn rl fixed" data-tire="RL">
                        <span class="tire-psi">--</span>
                        <span class="tire-label">psi</span>
                        <span class="tire-timestamp">1분 전</span>
                    </button>
                    <button class="tire-btn rr" data-tire="RR">
                        <span class="tire-psi">--</span>
                        <span class="tire-label">psi</span>
                    </button>
                </div>

                <!-- Drive Mode Controls -->
                <div class="drive-mode-controls">
                    <button class="mode-btn active" data-mode="normal">Normal</button>
                    <button class="mode-btn" data-mode="sports">Sports</button>
                    <button class="mode-btn" data-mode="comfort">Comfort</button>
                    <button class="mode-btn" data-mode="smart">SMART</button>
                </div>

                <!-- Smart Mode Modal -->
                <div id="smart-modal" class="modal hidden">
                    <div class="modal-content">
                        <button class="close-modal">&times;</button>
                        <h2 style="margin-bottom: 0.5rem;">스마트 공기압 설정</h2>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">날씨와 노면에 맞는 최적의 공기압을 추천합니다.</p>

                        <div class="smart-controls">
                            <select id="weather-select" class="smart-select">
                                <option value="normal">평상시 (Normal)</option>
                                <option value="rain">우천 시 (Rain)</option>
                                <option value="snow">강설 시 (Snow)</option>
                                <option value="heat">폭염 시 (Heat)</option>
                            </select>
                            <select id="road-select" class="smart-select">
                                <option value="asphalt">아스팔트 (Asphalt)</option>
                                <option value="wet">젖은 노면 (Wet)</option>
                                <option value="snow">눈길 (Snow)</option>
                                <option value="gravel">자갈길 (Gravel)</option>
                                <option value="mud">진흙길 (Mud)</option>
                            </select>
                        </div>

                        <div class="recommendation">
                            추천 공기압: <span id="rec-psi">34</span> PSI
                        </div>

                        <button id="apply-smart-btn" class="btn-neon-white">✅ 적용하기</button>
                    </div>
                </div>

                <div class="dashboard-footer">
                    <button class="footer-btn">
                        <i data-lucide="flashlight" class="icon"></i>
                        <span>플래시</span>
                    </button>
                    <button class="footer-btn">
                        <i data-lucide="megaphone" class="icon"></i>
                        <span>경적</span>
                    </button>
                    <button class="footer-btn">
                        <i data-lucide="wind" class="icon"></i>
                        <span>환기</span>
                    </button>
                    <button class="footer-btn">
                        <i data-lucide="thermometer" class="icon"></i>
                        <span>온도</span>
                    </button>
                </div>
            </div>

            <!-- Control Panel View -->
            <div id="control-view" class="hidden">
                <div class="control-header">
                    <button id="back-to-dashboard" class="back-btn"><i data-lucide="chevron-left"></i> 뒤로</button>
                    <h2 id="current-tire-title">앞왼쪽 타이어</h2>
                </div>

                <div id="pressure-display" class="pressure-display">
                    <span id="pressure-value">--</span><span class="pressure-unit">PSI</span>
                </div>
                <div id="target-control" class="target-control">
                    <div class="target-label">목표 압력</div>
                    <div class="target-input-group">
                        <button id="target-minus" class="target-btn">−</button>
                        <input type="number" id="target-psi" class="target-input" value="34" min="0" max="100" step="1">
                        <button id="target-plus" class="target-btn">+</button>
                        <span class="target-unit">PSI</span>
                    </div>
                    <button id="auto-start-btn" class="btn-auto"><i data-lucide="bot"></i> 자동 조절 시작</button>
                </div>
                <div class="controls" id="control-panel">
                    <div class="control-group">
                        <button id="inflate-btn" class="btn-control inflate">
                            <span class="label">공기 주입</span>
                            <span class="sub-label">누르고 있으면 주입됩니다</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="deflate-btn" class="btn-control deflate">
                            <span class="label">공기 배출</span>
                            <span class="sub-label">누르고 있으면 배출됩니다</span>
                        </button>
                    </div>
                </div>
                <div id="log-area" class="log-area">
                    <p>준비 완료</p>
                </div>
            </div>
        </main>
    </div>
    <button id="fullscreen-btn" class="fullscreen-btn" title="전체화면"><i data-lucide="maximize"></i></button>

    <script>
        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const controlPanel = document.getElementById('control-panel');
        const inflateBtn = document.getElementById('inflate-btn');
        const deflateBtn = document.getElementById('deflate-btn');
        const logArea = document.getElementById('log-area');
        const pressureDisplay = document.getElementById('pressure-display');
        const pressureValue = document.getElementById('pressure-value');
        const testModeBtn = document.getElementById('test-mode-btn');
        const targetPsiInput = document.getElementById('target-psi');
        const autoStartBtn = document.getElementById('auto-start-btn');
        const targetMinusBtn = document.getElementById('target-minus');
        const targetPlusBtn = document.getElementById('target-plus');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        let currentPressure = parseFloat(localStorage.getItem('savedPressure')) || 30.0;
        let tankPressure = 100.0;
        let isRelayOn = false;
        let relayAction = null;
        let physicsInterval = null;
        let lastInflateTime = 0;
        let isSimulation = false;
        let isAutoMode = false;
        let autoCheckInterval = null;
        let tirePressures = { FL: 36.0, FR: 36.0, RL: 36.0, RR: 30.0 };
        let currentTireId = null;
        let controlTimeout = null;

        // Storage Keys
        const STORAGE_KEY_SIM = 'tirePressures_sim';
        const STORAGE_KEY_BLE = 'tirePressures_ble';

        function getStorageKey() {
            return isSimulation ? STORAGE_KEY_SIM : STORAGE_KEY_BLE;
        }

        // Bluetooth Constants
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        let bleDevice = null;
        let bleServer = null;
        let bleService = null;
        let bleCharacteristic = null;

        function log(message) {
            console.log(message);
            logArea.textContent = message;
        }

        function loadTirePressures() {
            const key = getStorageKey();
            const saved = localStorage.getItem(key);
            if (saved) {
                tirePressures = JSON.parse(saved);
            } else {
                // Default values if not saved
                tirePressures = { FL: 36.0, FR: 36.0, RL: 36.0, RR: 30.0 };
            }
        }

        function saveTirePressures() {
            const key = getStorageKey();
            localStorage.setItem(key, JSON.stringify(tirePressures));
        }

        function updateDashboardUI() {
            document.querySelector('.tire-btn.fl .tire-psi').textContent = tirePressures.FL.toFixed(1);
            document.querySelector('.tire-btn.fr .tire-psi').textContent = tirePressures.FR.toFixed(1);
            document.querySelector('.tire-btn.rl .tire-psi').textContent = tirePressures.RL.toFixed(1);
            document.querySelector('.tire-btn.rr .tire-psi').textContent = tirePressures.RR.toFixed(1);

            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function showDashboard() {
            const dashboardView = document.getElementById('dashboard-view');
            const controlView = document.getElementById('control-view');
            const connectionView = document.getElementById('connection-view');

            connectionView.classList.add('hidden');
            controlView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            updateDashboardUI();

            if (relayAction) stopControl(relayAction);
            if (isAutoMode) stopAutoControl();
        }

        function showControlPanel(tireId) {
            const dashboardView = document.getElementById('dashboard-view');
            const controlView = document.getElementById('control-view');
            const currentTireTitle = document.getElementById('current-tire-title');

            currentTireId = tireId;
            currentPressure = tirePressures[tireId];

            let tireName = "";
            switch (tireId) {
                case 'FL': tireName = "앞왼쪽 타이어"; break;
                case 'FR': tireName = "앞오른쪽 타이어"; break;
                case 'RL': tireName = "뒤왼쪽 타이어"; break;
                case 'RR': tireName = "뒤오른쪽 타이어"; break;
            }
            currentTireTitle.textContent = tireName;

            dashboardView.classList.add('hidden');
            controlView.classList.remove('hidden');
            updatePressureDisplay();
        }

        function updatePressureDisplay() {
            pressureValue.textContent = currentPressure.toFixed(1);

            if (currentTireId) {
                tirePressures[currentTireId] = currentPressure;
                saveTirePressures();
            }
        }

        async function connectToDevice() {
            try {
                log("블루투스 장치 요청 중...");
                bleDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                log("GATT 서버에 연결 중...");
                bleServer = await bleDevice.gatt.connect();

                log("서비스 가져오는 중... UUID: " + SERVICE_UUID);
                bleService = await bleServer.getPrimaryService(SERVICE_UUID);

                log("특성(Characteristic) 가져오는 중... UUID: " + CHARACTERISTIC_UUID);
                bleCharacteristic = await bleService.getCharacteristic(CHARACTERISTIC_UUID);

                log("연결 성공!");
                isSimulation = false;
                loadTirePressures();
                updateConnectionState(true);
                showDashboard();

            } catch (error) {
                console.error("Connection failed", error);
                log("연결 실패: " + error.message);
            }
        }

        function onDisconnected(event) {
            log("장치 연결이 끊어졌습니다.");
            updateConnectionState(false);
        }

        function updateConnectionState(isConnected) {
            if (isConnected) {
                connectionStatus.textContent = "연결됨";
                connectionStatus.classList.remove('disconnected');
                connectionStatus.classList.add('connected');
                controlPanel.classList.remove('disabled');
                connectBtn.style.display = 'none';
                pressureDisplay.classList.remove('hidden');
                log("장치가 연결되었습니다. 준비 완료.");

                // Start physics engine for pressure simulation even in BLE mode
                startPhysicsEngine();
            } else {
                connectionStatus.textContent = "연결 끊김";
                connectionStatus.classList.add('disconnected');
                connectionStatus.classList.remove('connected');
                controlPanel.classList.add('disabled');
                connectBtn.style.display = 'block';
                pressureDisplay.classList.add('hidden');

                if (physicsInterval) {
                    clearInterval(physicsInterval);
                    physicsInterval = null;
                }
            }
        }

        async function sendCommand(cmd) {
            if (isSimulation) return;
            if (!bleCharacteristic) {
                log("연결되지 않음.");
                return;
            }
            try {
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode(cmd));
                console.log("Sent command:", cmd);
            } catch (error) {
                console.error("Write failed", error);
                log("명령 전송 오류.");
            }
        }

        function startPhysicsEngine() {
            if (physicsInterval) clearInterval(physicsInterval);

            physicsInterval = setInterval(() => {
                const now = Date.now();
                const deltaTime = 0.1; // seconds

                if (isRelayOn && relayAction) {
                    if (relayAction === 'inflate') {
                        currentPressure += 0.15 * deltaTime; // 0.15 PSI/s
                        if (currentPressure > 100) currentPressure = 100;
                    } else if (relayAction === 'deflate') {
                        currentPressure -= 0.15 * deltaTime; // 0.15 PSI/s
                        if (currentPressure < 0) currentPressure = 0;
                    }
                    updatePressureDisplay();
                    checkSafetyLimits();
                }
            }, 100);
        }

        function checkSafetyLimits() {
            const inflateDisabled = currentPressure >= 50;
            const deflateDisabled = currentPressure <= 20;

            if (inflateDisabled) {
                inflateBtn.classList.add('disabled');
                inflateBtn.disabled = true;
                if (relayAction === 'inflate') {
                    stopControl('inflate');
                    log("⚠️ 최대 압력(50 PSI) 도달. 주입 중단.");
                }
            } else {
                inflateBtn.classList.remove('disabled');
                inflateBtn.disabled = false;
            }

            if (deflateDisabled) {
                deflateBtn.classList.add('disabled');
                deflateBtn.disabled = true;
                if (relayAction === 'deflate') {
                    stopControl('deflate');
                    log("⚠️ 최소 압력(20 PSI) 도달. 배출 중단.");
                }
            } else {
                deflateBtn.classList.remove('disabled');
                deflateBtn.disabled = false;
            }

            if (currentPressure < 20) {
                // log("⚠️ 위험: 안전 범위 이하 (20 PSI 미만). 배출 차단됨.");
            } else if (currentPressure < 25) {
                log("⚠️ 저압 주의: 실제 차량에서는 주행이 위험할 수 있는 수준입니다.");
            } else if (currentPressure > 50) {
                // log("⚠️ 위험: 안전 범위 초과 (50 PSI 이상). 주입 차단됨.");
            } else if (currentPressure > 45) {
                log("⚠️ 고압 주의: 실제 차량에서는 타이어 손상 위험이 있을 수 있습니다.");
            }
        }

        function startControl(action, immediate = false) {
            const btn = (action === 'inflate') ? inflateBtn : deflateBtn;
            if (btn.disabled) {
                log("안전 범위를 벗어나 제어가 제한되었습니다.");
                return;
            }

            // Clear any existing timeout
            if (controlTimeout) clearTimeout(controlTimeout);

            // 1. Send BLE Command IMMEDIATELY
            const cmdStart = (action === 'inflate') ? 'I' : 'D';
            setRelayState(true, cmdStart);

            // 2. Manage RelayAction (Physics/UI update)
            if (immediate) {
                relayAction = action;
            } else {
                // Delay UI updates by 1 second
                controlTimeout = setTimeout(() => {
                    relayAction = action;
                }, 1000);
            }
        }

        function stopControl(action) {
            // Clear timeout if button released before 1 second
            if (controlTimeout) {
                clearTimeout(controlTimeout);
                controlTimeout = null;
            }

            // Always send stop command
            const cmdStop = (action === 'inflate') ? 'i' : 'd';
            setRelayState(false, cmdStop);

            // Reset relayAction
            relayAction = null;
        }

        function setRelayState(state, cmd) {
            isRelayOn = state;
            sendCommand(cmd);
        }

        function setupButtonListeners(btn, action) {
            const startAction = (e) => {
                e.preventDefault();
                btn.classList.add('active');
                startControl(action);
            };
            const stopAction = (e) => {
                e.preventDefault();
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    stopControl(action);
                }
            };

            btn.addEventListener('mousedown', startAction);
            btn.addEventListener('mouseup', stopAction);
            btn.addEventListener('mouseleave', stopAction);
            btn.addEventListener('touchstart', startAction);
            btn.addEventListener('touchend', stopAction);
            btn.addEventListener('touchcancel', stopAction);
        }

        // Smart Pressure Table
        const SMART_PRESSURE_TABLE = {
            'normal': { 'asphalt': 34, 'wet': 35, 'snow': 32, 'gravel': 31, 'mud': 31 },
            'rain': { 'asphalt': 35, 'wet': 36, 'snow': 33, 'gravel': 32, 'mud': 32 },
            'snow': { 'asphalt': 32, 'wet': 33, 'snow': 30, 'gravel': 29, 'mud': 29 },
            'heat': { 'asphalt': 32.5, 'wet': 33.5, 'snow': 30.5, 'gravel': 29.5, 'mud': 29.5 }
        };

        // Smart Mode Elements
        const smartModal = document.getElementById('smart-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const weatherSelect = document.getElementById('weather-select');
        const roadSelect = document.getElementById('road-select');
        const recPsiDisplay = document.getElementById('rec-psi');
        const applySmartBtn = document.getElementById('apply-smart-btn');
        const smartModeBtn = document.querySelector('.mode-btn[data-mode="smart"]');

        function updateSmartRecommendation() {
            const weather = weatherSelect.value;
            const road = roadSelect.value;
            const recPsi = SMART_PRESSURE_TABLE[weather][road];
            recPsiDisplay.textContent = recPsi;
        }

        weatherSelect.addEventListener('change', updateSmartRecommendation);
        roadSelect.addEventListener('change', updateSmartRecommendation);

        smartModeBtn.addEventListener('click', () => {
            if (isSimulation) {
                alert("테스트 모드(시뮬레이션)에서는 스마트 모드를 사용할 수 없습니다.");
                return;
            }
            smartModal.classList.remove('hidden');
            updateSmartRecommendation();
        });

        closeModalBtn.addEventListener('click', () => {
            smartModal.classList.add('hidden');
        });

        // Close modal when clicking outside
        smartModal.addEventListener('click', (e) => {
            if (e.target === smartModal) {
                smartModal.classList.add('hidden');
            }
        });

        applySmartBtn.addEventListener('click', () => {
            if (isSimulation) return;

            const weather = weatherSelect.value;
            const road = roadSelect.value;
            const targetPsi = SMART_PRESSURE_TABLE[weather][road];

            // Apply to FL, FR, RL (Skip RR)
            tirePressures.FL = targetPsi;
            tirePressures.FR = targetPsi;
            tirePressures.RL = targetPsi;
            // RR is exception

            saveTirePressures();
            updateDashboardUI();

            // Send BLE commands if connected
            if (bleCharacteristic) {
                sendCommand(`SET_FL:${targetPsi}`);
                sendCommand(`SET_FR:${targetPsi}`);
                sendCommand(`SET_RL:${targetPsi}`);
            }

            smartModal.classList.add('hidden');

            // Visual feedback on Smart button
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            smartModeBtn.classList.add('active');
        });

        // Drive Mode Logic
        document.querySelectorAll('.mode-btn').forEach(btn => {
            if (btn.dataset.mode === 'smart') return; // Handled separately

            btn.addEventListener('click', () => {
                if (isSimulation) {
                    alert("테스트 모드(시뮬레이션)에서는 주행 모드를 변경할 수 없습니다.");
                    return;
                }

                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const mode = btn.dataset.mode;
                let fl, fr, rl;

                if (mode === 'normal') {
                    fl = 34; fr = 34; rl = 34;
                } else if (mode === 'sports') {
                    fl = 36; fr = 36; rl = 35;
                } else if (mode === 'comfort') {
                    fl = 32; fr = 32; rl = 32;
                }

                // Apply to FL, FR, RL (Skip RR)
                if (fl !== undefined) {
                    tirePressures.FL = fl;
                    tirePressures.FR = fr;
                    tirePressures.RL = rl;
                    // RR is exception

                    saveTirePressures();
                    updateDashboardUI();

                    if (bleCharacteristic) {
                        sendCommand(`SET_FL:${fl}`);
                        sendCommand(`SET_FR:${fr}`);
                        sendCommand(`SET_RL:${rl}`);
                    }
                }
            });
        });

        connectBtn.addEventListener('click', () => {
            if (!navigator.bluetooth) {
                alert("이 브라우저는 웹 블루투스를 지원하지 않습니다.\n\n아이폰/아이패드(iOS) 사용자는 'Bluefy' 앱을 설치하여 실행해주세요.");
                return;
            }
            connectToDevice();
        });

        testModeBtn.addEventListener('click', () => {
            isSimulation = true;
            loadTirePressures();
            updateConnectionState(true); // Simulate connection
            showDashboard();
            log("테스트 모드(시뮬레이션) 시작");
        });

        // Setup Tire Button Listeners
        const tireBtns = document.querySelectorAll('.tire-btn');
        tireBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tireId = btn.dataset.tire;
                showControlPanel(tireId);
            });
        });

        const backBtn = document.getElementById('back-to-dashboard');
        backBtn.addEventListener('click', () => {
            showDashboard();
        });

        targetMinusBtn.addEventListener('click', () => {
            const current = parseInt(targetPsiInput.value);
            if (current > 0) {
                targetPsiInput.value = current - 1;
            }
        });

        targetPlusBtn.addEventListener('click', () => {
            const current = parseInt(targetPsiInput.value);
            if (current < 100) {
                targetPsiInput.value = current + 1;
            }
        });

        autoStartBtn.addEventListener('click', () => {
            if (!isAutoMode) {
                isAutoMode = true;
                autoStartBtn.classList.add('active');
                autoStartBtn.innerHTML = '<i data-lucide="square"></i> 자동 조절 중지';
                lucide.createIcons();
                log("자동 조절 시작...");
                startAutoControl();
            } else {
                stopAutoControl();
            }
        });

        function startAutoControl() {
            if (autoCheckInterval) clearInterval(autoCheckInterval);
            const targetPsi = parseFloat(targetPsiInput.value);

            if (targetPsi < 20 || targetPsi > 50) {
                log("⚠️ 안전 범위를 벗어난 목표값입니다. 20~50 PSI 범위 내에서 설정하세요.");
                isAutoMode = false;
                autoStartBtn.classList.remove('active');
                autoStartBtn.innerHTML = '<i data-lucide="bot"></i> 자동 조절 시작';
                lucide.createIcons();
                return;
            }

            controlPanel.classList.add('disabled');
            const margin = 0.05;

            autoCheckInterval = setInterval(() => {
                const P_now = currentPressure;

                if (P_now < targetPsi - margin) {
                    if (P_now >= 50) {
                        log("⚠️ 50 PSI 이상이므로 주입이 차단됩니다.");
                        stopAutoControl();
                        return;
                    }
                    if (relayAction !== 'inflate') {
                        if (relayAction === 'deflate') stopControl('deflate');
                        log(`주입 중... (현재: ${P_now.toFixed(1)} PSI → 목표: ${targetPsi} PSI)`);
                        startControl('inflate', true);
                    }
                } else if (P_now > targetPsi + margin) {
                    if (P_now <= 20) {
                        log("⚠️ 20 PSI 이하이므로 배출이 차단됩니다.");
                        stopAutoControl();
                        return;
                    }
                    if (relayAction !== 'deflate') {
                        if (relayAction === 'inflate') stopControl('inflate');
                        log(`배출 중... (현재: ${P_now.toFixed(1)} PSI → 목표: ${targetPsi} PSI)`);
                        startControl('deflate', true);
                    }
                } else {
                    if (relayAction) stopControl(relayAction);
                    log(`목표 압력 도달: ${targetPsi} PSI`);
                    stopAutoControl();
                }
            }, 150);
        }

        function stopAutoControl() {
            isAutoMode = false;
            autoStartBtn.classList.remove('active');
            autoStartBtn.innerHTML = '<i data-lucide="bot"></i> 자동 조절 시작';
            lucide.createIcons();

            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
            }
            if (relayAction) stopControl(relayAction);
            controlPanel.classList.remove('disabled');
            log("자동 조절 중지됨.");
        }

        setupButtonListeners(inflateBtn, 'inflate');
        setupButtonListeners(deflateBtn, 'deflate');

        fullscreenBtn.addEventListener('click', () => {
            const docEl = document.documentElement;
            const requestFull = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;

            if (!requestFull) {
                alert("현재 브라우저(iOS/Bluefy)에서는 전체화면 모드를 지원하지 않습니다.\n\n* '홈 화면에 추가'를 하면 전체화면이 되지만, 블루투스 연결이 안 될 수 있습니다. Bluefy 앱 내에서 사용해주세요.");
                return;
            }

            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                requestFull.call(docEl).catch(err => {
                    console.log('Fullscreen error:', err);
                    alert("전체화면 전환에 실패했습니다.");
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenBtn.classList.add('fullscreen-active');
            } else {
                fullscreenBtn.classList.remove('fullscreen-active');
            }
        });

        // Initialize Dashboard UI on load
        loadTirePressures();
        updateDashboardUI();
        log("연결 대기 중...");
    </script>
</body>

</html>
