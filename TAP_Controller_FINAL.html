<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAP Controller</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TAP">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <style>
        :root {
            --bg-color: #fff;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --accent-color: #000;
            --inflate-color: #4ade80;
            --deflate-color: #f87171;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #fff;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 1rem;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        header {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -1px;
        }

        .status-badge {
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 600;
            background: #f3f4f6;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .status-badge.connected {
            color: #15803d;
            background: #dcfce7;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
        }

        .pressure-display {
            text-align: center;
            margin: 1rem 0;
            transition: opacity 0.3s ease;
        }

        .pressure-display.hidden {
            display: none;
        }

        #pressure-value {
            font-size: 4rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        .pressure-unit {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-left: 0.5rem;
            vertical-align: super;
        }

        .target-control {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
        }

        .target-control.hidden {
            display: none;
        }

        .target-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .target-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .target-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: #fff;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .target-btn:active {
            transform: scale(0.95);
            background: #f1f5f9;
        }

        .target-input {
            width: 80px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: #fff;
            border-radius: 0.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
        }

        .target-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .target-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .btn-auto {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
        }

        .btn-auto:active {
            transform: scale(0.98);
        }

        .btn-auto.active {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
            box-shadow: 0 4px 6px -1px rgba(248, 113, 113, 0.3);
        }

        .btn-primary {
            width: 100%;
            padding: 1.2rem;
            border: none;
            border-radius: 1rem;
            background: var(--accent-color);
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-grow: 1;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
            padding: 2rem 0;
        }

        .controls.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .control-group {
            flex: 1;
            display: flex;
        }

        .btn-control {
            width: 100%;
            min-height: 120px;
            border: none;
            border-radius: 1.5rem;
            background: #f8fafc;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-control .label {
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .btn-control .sub-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .btn-control.inflate:active,
        .btn-control.inflate.active {
            background: #f0fdf4;
            border-color: var(--inflate-color);
            transform: scale(0.98);
        }

        .btn-control.inflate:active .label,
        .btn-control.inflate.active .label {
            color: var(--inflate-color);
        }

        .btn-control.deflate:active,
        .btn-control.deflate.active {
            background: #fef2f2;
            border-color: var(--deflate-color);
            transform: scale(0.98);
        }

        .btn-control.deflate:active .label,
        .btn-control.deflate.active .label {
            color: var(--deflate-color);
        }

        .btn-control.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .log-area {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            min-height: 1.5rem;
            padding-bottom: 1rem;
        }

        .btn-secondary {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 1rem;
            background: #f1f5f9;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .btn-secondary:active {
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .fullscreen-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 0.75rem;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn.fullscreen-active {
            background: rgba(0, 0, 0, 0.1);
            color: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
            background: rgba(0, 0, 0, 0.9);
        }

        .car-container {
            position: relative;
            width: 100%;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .car-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            opacity: 0.9;
        }

        .tire-btn {
            position: absolute;
            background: none;
            border: none;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tire-btn:active {
            transform: scale(0.95);
        }

        .tire-psi {
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .tire-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Positioning Tire Buttons (Adjust based on image) */
        .tire-btn.fl {
            top: 20%;
            left: 10%;
        }

        .tire-btn.fr {
            top: 20%;
            right: 10%;
        }

        .tire-btn.rl {
            bottom: 25%;
            left: 10%;
        }

        .tire-btn.rr {
            bottom: 25%;
            right: 10%;
        }

        .dashboard-footer {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: auto;
            width: 100%;
        }

        .footer-btn {
            background: #f8fafc;
            border: none;
            border-radius: 1rem;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .footer-btn:active {
            background: #e2e8f0;
            transform: scale(0.95);
        }

        .footer-btn .icon {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1rem;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    const connectBtn = document.getElementById('connect-btn');
    const connectionStatus = document.getElementById('connection-status');
    const controlPanel = document.getElementById('control-panel');
    const inflateBtn = document.getElementById('inflate-btn');
    const deflateBtn = document.getElementById('deflate-btn');
    const logArea = document.getElementById('log-area');
    const pressureDisplay = document.getElementById('pressure-display');
    const pressureValue = document.getElementById('pressure-value');
    const testModeBtn = document.getElementById('test-mode-btn');
    const targetPsiInput = document.getElementById('target-psi');
    const targetMinusBtn = document.getElementById('target-minus');
    const targetPlusBtn = document.getElementById('target-plus');
    const autoStartBtn = document.getElementById('auto-start-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    let bleDevice = null;
    let bleServer = null;
    let bleService = null;
    let bleCharacteristic = null;

    let currentPressure = parseFloat(localStorage.getItem('savedPressure')) || 30.0;
    let tankPressure = 100.0;
    let isRelayOn = false;
    let relayAction = null;
    let physicsInterval = null;
    let lastInflateTime = 0;
    let isSimulation = false;
    let isAutoMode = false;
    let autoCheckInterval = null;

    function log(message) {
    console.log(message);
    logArea.textContent = message;
    }

    function updateConnectionState(isConnected) {
    if (isConnected) {
    connectionStatus.textContent = "Ïó∞Í≤∞Îê®";
    connectionStatus.classList.remove('disconnected');
    connectionStatus.classList.add('connected');
    controlPanel.classList.remove('disabled');
    connectBtn.style.display = 'none';
    pressureDisplay.classList.remove('hidden');
    updatePressureDisplay();
    log("Ïû•ÏπòÍ∞Ä Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§. Ï§ÄÎπÑ ÏôÑÎ£å.");
    } else {
    connectionStatus.textContent = "Ïó∞Í≤∞ ÎÅäÍπÄ";
    connectionStatus.classList.remove('connected');
    connectionStatus.classList.add('disconnected');
    controlPanel.classList.add('disabled');
    connectBtn.style.display = 'flex';
    pressureDisplay.classList.add('hidden');
    log("Ïû•Ïπò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.");
    bleCharacteristic = null;
    }
    }

    justify-content: center;
    }

    .fullscreen-btn.fullscreen-active {
    background: rgba(0, 0, 0, 0.1);
    color: rgba(255, 255, 255, 0.3);
    }

    .fullscreen-btn:active {
    transform: scale(0.95);
    background: rgba(0, 0, 0, 0.9);
    }

    .car-container {
    position: relative;
    width: 100%;
    height: 500px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2rem;
    }

    .car-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    opacity: 0.9;
    }

    .tire-btn {
    position: absolute;
    background: none;
    border: none;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s;
    }

    .tire-btn:active {
    transform: scale(0.95);
    }

    .tire-psi {
    font-size: 2rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .tire-label {
    font-size: 0.8rem;
    opacity: 0.8;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Positioning Tire Buttons (Adjust based on image) */
    .tire-btn.fl {
    top: 20%;
    left: 10%;
    }

    .tire-btn.fr {
    top: 20%;
    right: 10%;
    }

    .tire-btn.rl {
    bottom: 25%;
    left: 10%;
    }

    .tire-btn.rr {
    bottom: 25%;
    right: 10%;
    }

    .dashboard-footer {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: auto;
    width: 100%;
    }

    .footer-btn {
    background: #f8fafc;
    border: none;
    border-radius: 1rem;
    padding: 1rem 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    }

    .footer-btn:active {
    background: #e2e8f0;
    transform: scale(0.95);
    }

    .footer-btn .icon {
    font-size: 1.5rem;
    margin-bottom: 0.2rem;
    }

    .control-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 1rem;
    }

    .back-btn {
    background: none;
    border: none;
    font-size: 1.1rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    }

    .hidden {
    display: none !important;
    }
    </style>
    </head>

    <body>

        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const controlPanel = document.getElementById('control-panel');
        const inflateBtn = document.getElementById('inflate-btn');
        const deflateBtn = document.getElementById('deflate-btn');
        const logArea = document.getElementById('log-area');
        const pressureDisplay = document.getElementById('pressure-display');
        const pressureValue = document.getElementById('pressure-value');
        const testModeBtn = document.getElementById('test-mode-btn');
        const targetPsiInput = document.getElementById('target-psi');
        const targetMinusBtn = document.getElementById('target-minus');
        const targetPlusBtn = document.getElementById('target-plus');
        const autoStartBtn = document.getElementById('auto-start-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        let bleDevice = null;
        let bleServer = null;
        let bleService = null;
        let bleCharacteristic = null;

        let currentPressure = parseFloat(localStorage.getItem('savedPressure')) || 30.0;
        let tankPressure = 100.0;
        let isRelayOn = false;
        let relayAction = null;
        let physicsInterval = null;
        let lastInflateTime = 0;
        let isSimulation = false;
        let isAutoMode = false;
        let autoCheckInterval = null;

        function log(message) {
        console.log(message);
        logArea.textContent = message;
        }

        function updateConnectionState(isConnected) {
        if (isConnected) {
        connectionStatus.textContent = "Ïó∞Í≤∞Îê®";
        connectionStatus.classList.remove('disconnected');
        connectionStatus.classList.add('connected');
        controlPanel.classList.remove('disabled');
        connectBtn.style.display = 'none';
        pressureDisplay.classList.remove('hidden');
        // updatePressureDisplay(); // This will be called by showControlPanel or showDashboard
        log("Ïû•ÏπòÍ∞Ä Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§. Ï§ÄÎπÑ ÏôÑÎ£å.");
        showDashboard(); // Show dashboard on successful connection
        } else {
        connectionStatus.textContent = "Ïó∞Í≤∞ ÎÅäÍπÄ";
        connectionStatus.classList.remove('connected');
        connectionStatus.classList.add('disconnected');
        controlPanel.classList.add('disabled');
        connectBtn.style.display = 'flex';
        pressureDisplay.classList.add('hidden');
        log("Ïû•Ïπò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.");
        bleCharacteristic = null;
        }
        }

        function updatePressureDisplay() {
        pressureValue.textContent = currentPressure.toFixed(1);
        // Update the specific tire state
        if (currentTireId) {
        tirePressures[currentTireId] = currentPressure;
        saveTirePressures();
        }
        }

        const dashboardView = document.getElementById('dashboard-view');
        const controlView = document.getElementById('control-view');
        const connectionView = document.getElementById('connection-view');
        const backBtn = document.getElementById('back-to-dashboard');
        const currentTireTitle = document.getElementById('current-tire-title');
        const tireBtns = document.querySelectorAll('.tire-btn');

        // State for 4 tires
        let tirePressures = JSON.parse(localStorage.getItem('tirePressures')) || {
        FL: 30.0, FR: 30.0, RL: 30.0, RR: 30.0
        };
        let currentTireId = null; // 'FL', 'FR', 'RL', 'RR'

        function saveTirePressures() {
        localStorage.setItem('tirePressures', JSON.stringify(tirePressures));
        }

        function updateDashboardUI() {
        document.querySelector('.tire-btn.fl .tire-psi').textContent = tirePressures.FL.toFixed(1);
        document.querySelector('.tire-btn.fr .tire-psi').textContent = tirePressures.FR.toFixed(1);
        document.querySelector('.tire-btn.rl .tire-psi').textContent = tirePressures.RL.toFixed(1);
        document.querySelector('.tire-btn.rr .tire-psi').textContent = tirePressures.RR.toFixed(1);
        }

        function showDashboard() {
        connectionView.classList.add('hidden');
        controlView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        updateDashboardUI();

        // Stop any active control when returning to dashboard
        if (relayAction) stopControl(relayAction);
        if (isAutoMode) stopAutoControl();
        }

        function showControlPanel(tireId) {
        currentTireId = tireId;
        currentPressure = tirePressures[tireId];

        let tireName = "";
        switch(tireId) {
        case 'FL': tireName = "ÏïûÏôºÏ™Ω ÌÉÄÏù¥Ïñ¥"; break;
        case 'FR': tireName = "ÏïûÏò§Î•∏Ï™Ω ÌÉÄÏù¥Ïñ¥"; break;
        case 'RL': tireName = "Îí§ÏôºÏ™Ω ÌÉÄÏù¥Ïñ¥"; break;
        case 'RR': tireName = "Îí§Ïò§Î•∏Ï™Ω ÌÉÄÏù¥Ïñ¥"; break;
        }
        currentTireTitle.textContent = tireName;

        dashboardView.classList.add('hidden');
        controlView.classList.remove('hidden');
        updatePressureDisplay();
        }

        // Tire Button Listeners
        tireBtns.forEach(btn => {
        btn.addEventListener('click', () => {
        const tireId = btn.dataset.tire;
        showControlPanel(tireId);
        });
        });

        // Back Button Listener
        backBtn.addEventListener('click', () => {
        showDashboard();
        });

        async function sendCommand(cmd) {
        if (isSimulation) return;
        if (!bleCharacteristic) {
        log("Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå.");
        return;
        }
        try {
        const encoder = new TextEncoder();
        await bleCharacteristic.writeValue(encoder.encode(cmd));
        console.log("Sent command:", cmd);
        } catch (error) {
        console.error("Write failed", error);
        log("Î™ÖÎ†π Ï†ÑÏÜ° Ïò§Î•ò.");
        }
        }

        function startPhysicsEngine() {
        if (physicsInterval) clearInterval(physicsInterval);

        let lastTickTime = Date.now();
        let lastDisplayUpdate = Date.now();
        let pressureChangeStartTime = null;

        physicsInterval = setInterval(() => {
        const now = Date.now();
        const deltaTime = (now - lastTickTime) / 1000;
        lastTickTime = now;

        if (!isRelayOn) {
        pressureChangeStartTime = null;
        if (now - lastDisplayUpdate >= 200) {
        updatePressureDisplay();
        lastDisplayUpdate = now;
        }
        return;
        }

        if (pressureChangeStartTime === null) {
        pressureChangeStartTime = Date.now();
        }

        const timeSincePressureStart = (now - pressureChangeStartTime) / 1000;

        if (timeSincePressureStart < 1.0) { if (now - lastDisplayUpdate>= 200) {
            updatePressureDisplay();
            checkSafetyLimits();
            lastDisplayUpdate = now;
            }
            return;
            }

            if (relayAction === 'inflate') {
            currentPressure += 0.2 * deltaTime;
            } else if (relayAction === 'deflate') {
            currentPressure -= 0.2 * deltaTime;
            }

            if (currentPressure < 0) currentPressure=0; if (currentPressure> 100) currentPressure = 100;

                if (now - lastDisplayUpdate >= 200) {
                updatePressureDisplay();
                checkSafetyLimits();
                lastDisplayUpdate = now;
                }
                }, 100);
                }

                function checkSafetyLimits() {
                const inflateDisabled = currentPressure >= 50;
                const deflateDisabled = currentPressure <= 20; if (inflateDisabled) {
                    inflateBtn.classList.add('disabled'); inflateBtn.disabled=true; } else {
                    inflateBtn.classList.remove('disabled'); inflateBtn.disabled=false; } if (deflateDisabled) {
                    deflateBtn.classList.add('disabled'); deflateBtn.disabled=true; } else {
                    deflateBtn.classList.remove('disabled'); deflateBtn.disabled=false; } if (currentPressure < 20) {
                    log("‚ö†Ô∏è ÏúÑÌóò: ÏïàÏ†Ñ Î≤îÏúÑ Ïù¥Ìïò (20 PSI ÎØ∏Îßå). Î∞∞Ï∂ú Ï∞®Îã®Îê®."); } else if (currentPressure < 25) { log("‚ö†Ô∏è Ï†ÄÏïï Ï£ºÏùò: Ïã§Ï†ú
                    Ï∞®ÎüâÏóêÏÑúÎäî Ï£ºÌñâÏù¥ ÏúÑÌóòÌï† Ïàò ÏûàÎäî ÏàòÏ§ÄÏûÖÎãàÎã§."); } else if (currentPressure> 50) {
                    log("‚ö†Ô∏è ÏúÑÌóò: ÏïàÏ†Ñ Î≤îÏúÑ Ï¥àÍ≥º (50 PSI Ïù¥ÏÉÅ). Ï£ºÏûÖ Ï∞®Îã®Îê®.");
                    } else if (currentPressure > 45) {
                    log("‚ö†Ô∏è Í≥†Ïïï Ï£ºÏùò: Ïã§Ï†ú Ï∞®ÎüâÏóêÏÑúÎäî ÌÉÄÏù¥Ïñ¥ ÏÜêÏÉÅ ÏúÑÌóòÏù¥ ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.");
                    }
                    }

                    function startControl(action) {
                    const btn = (action === 'inflate') ? inflateBtn : deflateBtn;
                    if (btn.disabled) {
                    log("ÏïàÏ†Ñ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇò Ï†úÏñ¥Í∞Ä Ï†úÌïúÎêòÏóàÏäµÎãàÎã§.");
                    return;
                    }
                    relayAction = action;
                    const cmdStart = (action === 'inflate') ? 'I' : 'D';
                    setRelayState(true, cmdStart);
                    }

                    function stopControl(action) {
                    const cmdStop = (action === 'inflate') ? 'i' : 'd';
                    setRelayState(false, cmdStop);
                    relayAction = null;
                    }

                    function setRelayState(state, cmd) {
                    isRelayOn = state;
                    sendCommand(cmd);
                    }

                    function setupButtonListeners(btn, action) {
                    const startAction = (e) => {
                    e.preventDefault();
                    btn.classList.add('active');
                    startControl(action);
                    };

                    const stopAction = (e) => {
                    e.preventDefault();
                    if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    stopControl(action);
                    }
                    };

                    btn.addEventListener('mousedown', startAction);
                    btn.addEventListener('mouseup', stopAction);
                    btn.addEventListener('mouseleave', stopAction);
                    btn.addEventListener('touchstart', startAction);
                    btn.addEventListener('touchend', stopAction);
                    btn.addEventListener('touchcancel', stopAction);
                    }

                    testModeBtn.addEventListener('click', () => {
                    isSimulation = true;
                    if (!localStorage.getItem('tirePressures')) {
                    tirePressures = {
                    FL: 28.0 + Math.random() * 4.0,
                    FR: 28.0 + Math.random() * 4.0,
                    RL: 28.0 + Math.random() * 4.0,
                    RR: 28.0 + Math.random() * 4.0
                    };
                    saveTirePressures();
                    }
                    updateConnectionState(true);
                    log("ÌÖåÏä§Ìä∏ Î™®Îìú ÌôúÏÑ±ÌôîÎê®.");
                    startPhysicsEngine();
                    showDashboard(); // Show dashboard on test mode activation

                    const targetControl = document.getElementById('target-control');
                    targetControl.classList.remove('hidden');
                    });

                    targetMinusBtn.addEventListener('click', () => {
                    const current = parseInt(targetPsiInput.value);
                    if (current > 0) {
                    targetPsiInput.value = current - 1;
                    }
                    });

                    targetPlusBtn.addEventListener('click', () => {
                    const current = parseInt(targetPsiInput.value);
                    if (current < 100) { targetPsiInput.value=current + 1; } }); autoStartBtn.addEventListener('click',
                        ()=> {
                        if (!isAutoMode) {
                        isAutoMode = true;
                        autoStartBtn.classList.add('active');
                        autoStartBtn.textContent = '‚èπÔ∏è ÏûêÎèô Ï°∞Ï†à Ï§ëÏßÄ';
                        log("ÏûêÎèô Ï°∞Ï†à ÏãúÏûë...");
                        startAutoControl();
                        } else {
                        stopAutoControl();
                        }
                        });

                        function startAutoControl() {
                        if (autoCheckInterval) clearInterval(autoCheckInterval);

                        const targetPsi = parseFloat(targetPsiInput.value);

                        if (targetPsi < 20 || targetPsi> 50) {
                            log("‚ö†Ô∏è ÏïàÏ†Ñ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇú Î™©ÌëúÍ∞íÏûÖÎãàÎã§. 20~50 PSI Î≤îÏúÑ ÎÇ¥ÏóêÏÑú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.");
                            isAutoMode = false;
                            autoStartBtn.classList.remove('active');
                            autoStartBtn.textContent = 'ü§ñ ÏûêÎèô Ï°∞Ï†à ÏãúÏûë';
                            return;
                            }

                            controlPanel.classList.add('disabled');

                            const margin = 0.05;
                            autoCheckInterval = setInterval(() => {
                            const targetPsi = parseFloat(targetPsiInput.value);
                            const P_now = currentPressure;

                            if (P_now < targetPsi - margin) { if (P_now>= 50) {
                                log("‚ö†Ô∏è 50 PSI Ïù¥ÏÉÅÏù¥ÎØÄÎ°ú Ï£ºÏûÖÏù¥ Ï∞®Îã®Îê©ÎãàÎã§.");
                                stopAutoControl();
                                return;
                                }
                                if (relayAction !== 'inflate') {
                                if (relayAction === 'deflate') {
                                stopControl('deflate');
                                }
                                log(`Ï£ºÏûÖ Ï§ë... (ÌòÑÏû¨: ${P_now.toFixed(1)} PSI ‚Üí Î™©Ìëú: ${targetPsi} PSI)`);
                                startControl('inflate');
                                }
                                } else if (P_now > targetPsi + margin) {
                                if (P_now <= 20) { log("‚ö†Ô∏è 20 PSI Ïù¥ÌïòÏù¥ÎØÄÎ°ú Î∞∞Ï∂úÏù¥ Ï∞®Îã®Îê©ÎãàÎã§."); stopAutoControl(); return; } if
                                    (relayAction !=='deflate' ) { if (relayAction==='inflate' ) {
                                    stopControl('inflate'); } log(`Î∞∞Ï∂ú Ï§ë... (ÌòÑÏû¨: ${P_now.toFixed(1)} PSI ‚Üí Î™©Ìëú:
                                    ${targetPsi} PSI)`); startControl('deflate'); } } else { if (relayAction) {
                                    stopControl(relayAction); } log(`Î™©Ìëú ÏïïÎ†• ÎèÑÎã¨: ${targetPsi} PSI`); stopAutoControl(); }
                                    }, 150); } function stopAutoControl() { isAutoMode=false;
                                    autoStartBtn.classList.remove('active'); autoStartBtn.textContent='ü§ñ ÏûêÎèô Ï°∞Ï†à ÏãúÏûë' ; if
                                    (autoCheckInterval) { clearInterval(autoCheckInterval); autoCheckInterval=null; } if
                                    (relayAction) { stopControl(relayAction); }
                                    controlPanel.classList.remove('disabled'); log("ÏûêÎèô Ï°∞Ï†à Ï§ëÏßÄÎê®."); } async function
                                    connectToDevice() { try { log("Î∏îÎ£®Ìà¨Ïä§ Ïû•Ïπò ÏöîÏ≤≠ Ï§ë..."); bleDevice=await
                                    navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices:
                                    [SERVICE_UUID] }); bleDevice.addEventListener('gattserverdisconnected',
                                    onDisconnected); log("GATT ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ Ï§ë..."); bleServer=await bleDevice.gatt.connect();
                                    log("ÏÑúÎπÑÏä§ Í∞ÄÏ†∏Ïò§Îäî Ï§ë..."); bleService=await bleServer.getPrimaryService(SERVICE_UUID);
                                    log("ÌäπÏÑ±(Characteristic) Í∞ÄÏ†∏Ïò§Îäî Ï§ë..."); bleCharacteristic=await
                                    bleService.getCharacteristic(CHARACTERISTIC_UUID); updateConnectionState(true); }
                                    catch (error) { console.error("Connection failed", error); log("Ïó∞Í≤∞ Ïã§Ìå®: " + error.message);
            }
        }

        function onDisconnected(event) {
            log(" Ïû•Ïπò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§."); updateConnectionState(false); } connectBtn.addEventListener('click', ()=> {
                                    if (!navigator.bluetooth) {
                                    alert("Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Ïõπ Î∏îÎ£®Ìà¨Ïä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.\n\nÏïÑÏù¥Ìè∞/ÏïÑÏù¥Ìå®Îìú(iOS) ÏÇ¨Ïö©ÏûêÎäî 'Bluefy' Ïï±ÏùÑ ÏÑ§ÏπòÌïòÏó¨ Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî.");
                                    return;
                                    }
                                    connectToDevice();
                                    });

                                    setupButtonListeners(inflateBtn, 'inflate');
                                    setupButtonListeners(deflateBtn, 'deflate');

                                    fullscreenBtn.addEventListener('click', () => {
                                    const docEl = document.documentElement;
                                    const requestFull = docEl.requestFullscreen || docEl.webkitRequestFullscreen ||
                                    docEl.msRequestFullscreen;

                                    if (!requestFull) {
                                    alert("ÌòÑÏû¨ Î∏åÎùºÏö∞Ï†Ä(iOS/Bluefy)ÏóêÏÑúÎäî Ï†ÑÏ≤¥ÌôîÎ©¥ Î™®ÎìúÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.\n\n* 'Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä'Î•º ÌïòÎ©¥ Ï†ÑÏ≤¥ÌôîÎ©¥Ïù¥ ÎêòÏßÄÎßå,
                                    Î∏îÎ£®Ìà¨Ïä§ Ïó∞Í≤∞Ïù¥ Ïïà Îê† Ïàò ÏûàÏäµÎãàÎã§. Bluefy Ïï± ÎÇ¥ÏóêÏÑú ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.");
                                    return;
                                    }

                                    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                                    requestFull.call(docEl).catch(err => {
                                    console.log('Fullscreen error:', err);
                                    alert("Ï†ÑÏ≤¥ÌôîÎ©¥ Ï†ÑÌôòÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                                    });
                                    } else {
                                    if (document.exitFullscreen) document.exitFullscreen();
                                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                                    }
                                    });

                                    document.addEventListener('fullscreenchange', () => {
                                    if (document.fullscreenElement) {
                                    fullscreenBtn.classList.add('fullscreen-active');
                                    } else {
                                    fullscreenBtn.classList.remove('fullscreen-active');
                                    }
                                    });

                                    // Initialize Dashboard UI on load
                                    updateDashboardUI();
                                    log("Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...");
                                    </script>
    </body>

</html>
